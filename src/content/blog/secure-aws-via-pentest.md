---
author: Nithissh S
pubDatetime: 2024-01-06
modDatetime: 2024-01-06
title: Securing AWS Discover Cloud vulnerabilities via Pentesting techniques
slug: securing-aws-via-pentest
featured: true
draft: false
tags:
  - AWS
  - Cloud Pentest
description:
  How we can secure our AWS infrastructure via pentest techniques
---

## Pentesting in AWS: Understanding Authentication, Permissions, and Security Risks

Amazon Web Services (AWS) is a popular cloud computing platform used by businesses around the world. While AWS provides a secure environment for cloud infrastructure, it’s important to understand the authentication methods, permissions, and security risks involved in pentesting in AWS. In this blog, we’ll explore the types of authentication in AWS, the different types of permissions, and potential security risks.

## Rules of Pentesting in AWS

As more businesses migrate to the cloud, securing cloud infrastructure from potential attacks becomes paramount. For penetration testers, understanding the rules and limitations of AWS pentesting is essential. This section delineates activities considered out of scope and those within scope during an AWS pentest.

### Out of Scope

Before delving into the scope of AWS pentesting, it's crucial to recognize activities deemed out of bounds. The following activities are typically not allowed during a pentest:

1. **Testing AWS Infrastructure:** AWS infrastructure is managed by Amazon, and testing it could potentially cause harm to other customers.
2. **DOS and DDOS Attack Without Notification:** Denial of Service (DOS) and Distributed Denial of Service (DDOS) attacks can inflict significant harm on the target infrastructure, making unnotified testing inappropriate.
3. **No Port Flooding:** Port flooding, involving sending a high volume of traffic to a specific port, is disallowed during a pentest as it can render the system unresponsive.
4. **No Protocol Flooding:** Similar to port flooding, flooding a specific protocol with high traffic is not allowed during a pentest.
5. **No Network Stress Testing Without Prior Notification:** Network stress testing, pushing the limits of network infrastructure, is prohibited without prior permission.

## In Scope

With the out-of-scope activities clarified, let's explore what typically falls within scope during an AWS pentest. The following AWS services are commonly tested:

1. **AWS EC2, NAT Gateways, and Elastic Load Balancers:** Commonly used for hosting applications and often targeted by attackers.
2. **Amazon RDS:** Utilized for hosting databases containing sensitive data that requires protection.
3. **Amazon CloudFront:** Employed for content delivery and susceptible to attacks aimed at gaining access to sensitive data.
4. **Amazon Aurora:** A MySQL-compatible database catering to high-performance applications.
5. **Amazon API Gateways:** Used for building, deploying, and managing APIs.
6. **AWS Lambda and Edge Functions:** Employed for serverless computing and may contain sensitive data requiring protection.
7. **Amazon Lightsail Resources:** A virtual private server hosting websites, blogs, and applications.
8. **AWS Elastic Beanstalk:** A platform for deploying and scaling web applications.

## Types of Authentication in AWS

AWS offers two primary types of authentication: programmatic access and management console access. These authentication methods provide users with access to AWS resources and services.

### Programmatic Access

Programmatic access allows users to access AWS resources programmatically using APIs and other tools. This type of access is commonly used by developers and other technical professionals who need to automate tasks and manage resources programmatically.

### Management Console Access

Management console access allows users to access AWS resources through a web-based console. This type of access is commonly used by non-technical users who need to manage AWS resources and services through a user-friendly interface.

## Initial Access on AWS

When accessing AWS, there are several potential security risks that businesses should be aware of, including:

### Public Accessible Resources

Publicly accessible resources, such as S3 buckets, can be exploited by attackers if they are not properly secured. If an S3 bucket is accessible to the public, an attacker could potentially access sensitive data stored in the bucket.

### Leaking Secrets in the Code Repo

Secrets, such as AWS access keys or other credentials, can be accidentally or deliberately leaked in code repositories. This can allow attackers to access sensitive data or resources.

### Phishing for Credentials

Attackers may use phishing attacks to trick users into revealing their AWS credentials. This can allow attackers to gain access to AWS resources and data.

### Resources Exploitation

AWS resources, such as EC2 instances and web applications, can be exploited if vulnerabilities exist. Attackers can exploit these vulnerabilities to gain access to AWS resources and data.

### Publicly Accessible Resource

Misconfiguration of the services exists in the AWS Cloud, including publicly accessible S3 buckets that expose data or have RWD access, insecure web apps and exposed functions, and databases with weak credentials.

## Examples

**Some examples of misconfigured AWS resources include:**

- Publicly accessible S3 buckets that expose data or have RWD access
- Insecure web apps and exposed functions
- Databases with weak credentials
- Secrets in code repositories

## AWS Permissions

AWS permissions are used to control access to AWS resources and services. There are three types of AWS permissions:

### Root User

Root users have access to almost everything within AWS and can perform any action on any resource.

### IAM User

IAM users have access to specific resources or based upon the team access. IAM users are created by the root user and can be granted access to specific AWS resources.

### Temporary Access

Temporary access is guest access that is granted to users who need to access AWS resources for a limited time. Temporary access is granted through AWS Identity and Access Management (IAM) roles.

AWS permissions are controlled through policies, which specify the effect, action, and resources that the policy allows or denies access to. Policies can be identity-based or resource-based, depending on whether they are applied to IAM users or specific resources.

## Intro to AWS CLI

The AWS CLI is a powerful tool for managing AWS resources and services from the command line. To use the AWS CLI, you must first configure AWS for CLI access using the aws configure command. You can also use the --profile option to specify a profile for determining what type of account to use.

### Some useful AWS CLI commands for resource enumeration include:

| AWS Command                                     | Description                                |
|-------------------------------------------------|--------------------------------------------|
| `aws s3 ls`                                     | To list S3 bucket contents                 |
| `aws ec2 describe-instances --region us-east-1` | To get information about EC2 instances    |
| `aws iam list-users`                            | To list IAM users                         |
| `aws iam list-roles`                            | To list IAM roles                         |
| `aws iam list-groups`                           | To list IAM groups                        |
| `aws iam list-attached-used-policies --user-name testbucket` | To list policies for specific users |



## Identifying Public Resources

Public resources, such as S3 buckets, can be identified using predictable URLs. Tools like CloudEnum can be used to brute force resource IDs and find publicly accessible S3 buckets.

### Privilege Escalation

Privilege escalation involves gaining higher levels of access to AWS resources and services. This can be achieved by gaining access to other user accounts or resources that have different privileges or by obtaining additional credentials or roles.

### Instance Metadata Service

The Instance Metadata Service (IMDS) is a service provided by AWS that allows EC2 instances to access metadata about themselves. Attackers can potentially exploit the IMDS to gain access to AWS resources and data. IMDSv1 is enabled by default and can be vulnerable to SSRF attacks. IMDSv2 provides a more secure way to access metadata.

### User Data and Environmental Variables

User data and environmental variables can contain sensitive information, such as AWS access credentials, Slack tokens, API keys, and SSH keys. If these variables are tied to a Lambda function, an attacker could potentially read the user data using AWS CLI.

To mitigate this risk, it’s important to ensure that user data and environmental variables are properly secured and not accessible to unauthorized users.

### Assume Role Policies

Assume role policies allow guest users to gain temporary access to AWS resources for a limited time. This access is granted through AWS Identity and Access Management (IAM) roles.

By default, assume role policies have a one-hour lifespan and are defined in IAM policies. They can be applied to large groups of users and provide temporary access to resources like S3 buckets and EC2 instances.

## Questions to Ask During Post-Compromise Recon

After a successful compromise, it’s important to ask yourself several questions to assess the extent of the damage and identify potential vulnerabilities:

- What roles do we have?
- Are MFA enabled?
- What can we access? (Storage, web apps, etc.)
- Who are the admins?
- How can we escalate from user-level privilege to admin-level?
- Are there any mitigations or protections in place? (CloudTrail, GuardDuty, etc.) 

## Cloud Pentest Cheatsheets

Cloud pentest cheatsheets are useful tools for testing EC2, ELB, and RDS resources. These cheatsheets provide step-by-step instructions for testing resources and identifying vulnerabilities. [Cheatsheets](https://github.com/dafthack/CloudPentestCheatsheets/blob/master/cheatsheets/AWS.md)

## Conclusion

In conclusion, AWS provides a secure cloud infrastructure, but businesses must take steps to ensure that their resources and data are properly secured. Understanding the authentication methods, permissions, and security risks involved in pentesting in AWS is essential for maintaining a secure cloud environment. By following best practices and regularly assessing vulnerabilities, businesses can ensure that their AWS resources are protected from potential threats.